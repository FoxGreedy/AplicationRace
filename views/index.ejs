<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <!-- CSS -->
    <link href="css/index.css" rel="stylesheet" />
    <link href="css/bootstrap.min.css" rel="stylesheet" />

    <!-- Javascript  -->
    <script src="js/jquery.js" type="text/javascript"></script>
    <script src="js/bootstrap.bundle.min.js" type="text/javascript"></script>
    <script src="js/bootstrap-dash.js"></script>
    <script src="js/scrollbarEffect.js"></script>

    <!-- Grafico -->
    <script src="js/Chart.bundle.min.js"></script>

</head>

<body id="home" onload="carregar()">

    <div id="container" style="height: 100%; position: absolute;">

        <!-- Logo -->
        <div>
            <div id="logo">
                <img src="img/AmericanTowerLogo.png">
            </div>
        </div>

        <div id="content" class="col-md-12">
            <!-- Map -->
            <div id="estmapa" class="row">
                <div id="mapa" class="col-md-12">
                    <div id="map" style="height: 100%"></div>
                </div>
            </div>
        </div>


        <div id="conteudo">
            <div class="fileira">
                <div id="linha" class="row">
                    <div class="col-sm">
                        <div class="card bg-dark rounded-0 border-dark text-white">
                            <div id="head1" class="card-header">
                                <img id="img1" src="./img/competidores/generic.png"
                                    class="rounded-circle mx-auto d-block border border-dark">
                                <h4 class="mt-0" style="text-align: center; ">1° Colocado</h4>
                            </div>
                            <div id="body1" class="card-body">
                                <b>Nome: </b><span id="nome1"></span><br>
                                <b>Equipe: </b> <span id="equipe1"></span> <br>
                                <b>Velocidade: </b><span id="velocidade1">0</span> Km/H <br>
                                <b>Ritmo/min: </b><span id="pace1">0s/Km</span><br>
                                <b>Total : </b><span id="distancia1">0</span>m <br>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm">
                        <div class="card bg-danger rounded-0 border-dark text-white">
                            <div id="head2" class="card-header">
                                <img id="img2" src="./img/competidores/generic.png"
                                    class="rounded-circle mx-auto d-block border border-dark">
                                <h4 class="mt-0" style="text-align: center">2° Colocado</h4>
                            </div>
                            <div id="body2" class="card-body ">
                                <b>Nome: </b><span id="nome2"></span><br>
                                <b>Equipe: </b> <span id="equipe2"></span> <br>
                                <b>Velocidade: </b><span id="velocidade2">0</span> Km/H <br>
                                <b>Ritmo/min: </b><span id="pace2">0s/Km</span> <br>
                                <b>Total : </b><span id="distancia2">0</span>m <br>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm">
                        <div class="card bg-danger rounded-0 border-dark text-white">
                            <div id="head3" class="card-header">
                                <img id="img3" src="./img/competidores/generic.png"
                                    class="rounded-circle mx-auto d-block border border-dark">
                                <h4 class="mt-0" style="text-align: center">3° Colocado</h4>
                            </div>
                            <div id="body3" class="card-body">
                                <b>Nome: </b><span id="nome3"></span><br>
                                <b>Equipe: </b> <span id="equipe3"></span> <br>
                                <b>Velocidade: </b><span id="velocidade3">0</span> <br>
                                <b>Ritmo/min: </b><span id="pace3">0s/Km</span><br>
                                <b>Total : </b><span id="distancia3">0</span>m <br>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm">
                        <div class="card bg-danger rounded-0 border-dark text-white">
                            <div id="head4" class="card-header">
                                <img id="img4" src="./img/competidores/generic.png"
                                    class="rounded-circle mx-auto d-block border border-dark">
                                <h4 class="mt-0" style="text-align: center">4° Colocado</h4>
                            </div>
                            <div id="body4" class="card-body text-white">
                                <b>Nome: </b><span id="nome4"></span><br>
                                <b>Equipe: </b> <span id="equipe4"></span> <br>
                                <b>Velocidade: </b><span id="velocidade4">0</span> <br>
                                <b>Ritmo/min: </b><span id="pace4">0s/Km</span><br>
                                <b>Total : </b><span id="distancia4">0</span>m <br>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm">
                        <div class="card bg-danger rounded-0 border-dark text-white">
                            <div id="head5" class="card-header">
                                <img id="img5" src="./img/competidores/generic.png"
                                    class="rounded-circle mx-auto d-block border border-dark">
                                <h4 class="mt-0" style="text-align: center">5° Colocado</h4>
                            </div>
                            <div id="body5" class="card-body  text-white">
                                <b>Nome: </b><span id="nome5"></span><br>
                                <b>Equipe: </b> <span id="equipe5"></span> <br>
                                <b>Velocidade: </b><span id="velocidade5">0</span> <br>
                                <b>Ritmo/min: </b><span id="pace5">0s/Km</span><br>
                                <b>Total : </b><span id="distancia5">0</span>m <br>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>



</body>

<script>



    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: -23.5911131, lng: -46.6475914 },
            zoom: 15,
            styles: [{
                "featureType": "poi",
                "stylers": [{
                    "visibility": "off"
                }]
            }],
            scrollwheel: false,
            disableDefaultUI: true
        });
    }

    function plottarGrafico(id) {

        new Chart(document.getElementById(id), {
            type: 'bar',
            data: {
                labels: ["1900", "1950", "1999", "2050"],
                datasets: [
                    {
                        label: "Africa",
                        backgroundColor: 'blue',
                        data: [133, 221, 783, 2478]
                    }, {
                        label: "Europe",
                        backgroundColor: "orange",
                        data: [408, 547, 675, 734]
                    }
                ]
            },
            options: {
                title: {
                    display: true,
                    text: 'Population growth (millions)',
                    fontColor: '#fff'

                },
                legend: {
                    labels: {
                        fontColor: '#fff'
                    },
                    fontColor: '#fff'
                }
            }
        });
    }

    // Variaveis Globais
    var pace = 0
    var Velocidade = 0


    function iniciarMarcacao() {
        $.ajax({
            cache: false,
            url: `/historico/gps`,
            success: (dados) => {
                console.log('dados', dados)
            }, 
            error: (err) => {
                console.error('Erro', err)
            }
        })
    }

    function carregar() {
        $.ajax({
            cache: false,
            url: '/dados/info',
            success: (dados) => {

                var todasInfosCompetidor = []

                let { participantes, infos } = dados

                for (dado in participantes) {
                    for (info in infos) {
                        if (participantes[dado].nome == infos[info].nomeCompetidor) {
                            todasInfosCompetidor.push({ participante: participantes[dado], information: infos[info] })
                        }
                    }
                }

                definirColocacao(todasInfosCompetidor)
                plottarDados(todasInfosCompetidor)

                iniciarMarcacao()
                // Marcador no mapa
                // console.log(todasInfosCompetidor)

            },
            error: (e) => {
                console.error('Error', e)
            }
        })
    }

    function calcularMomento(momento1, momento2) {
        return momento2 - momento1
    }

    function tranformarMomentoSegundos(momento) {
        var tempo = momento.split(':')
        var horas = tempo[0]
        var minutos = tempo[1]

        segundos = (Number(horas) * 3600) + (Number(minutos) * 60) + Number(tempo[2])
        return segundos
    }

    function filtrarHorario(momento) {
        var horas = momento.split('T')
        horas = horas[1].split('.')
        return horas[0]
    }

    function calcularVelocidade(distancia, tempo) {
        var velocidade = distancia / tempo
        return (velocidade * 3.6).toFixed(2)
    }

    function calcularPace(distancia, tempo) {
        if (distancia <= 0 && tempo <= 0) {
            return `0s/Km`
        } else {
            var minutos = Number(tempo) / 60
            var quilometros = Number(distancia) / 1000

            var pace = minutos / quilometros

            if (pace < 1) {
                return `${parseInt((pace % 60) * 60)}s/Km`
            } else if (pace % 1 === 0) {
                return `${parseInt(pace)}min/Km`
            } else {
                return `${parseInt(pace)}min ${parseInt(((pace * 60) % 60))}s/Km`
            }
        }

    }

    function definirColocacao(info) {

        function comparer(a, b) {
            if (a.information.distanciaTotal < b.information.distanciaTotal)
                return 1;

            if (a.information.distanciaTotal > b.information.distanciaTotal)
                return -1;

            return 0;
        }

        info.sort(comparer);

    }

    function plottarDados(infos) {
        for (info in infos) {

            document.getElementById(`nome${Number(info) + 1}`).innerHTML = infos[info].participante.nome
            document.getElementById(`equipe${Number(info) + 1}`).innerHTML = infos[info].participante.equipe
            document.getElementById(`distancia${Number(info) + 1}`).innerHTML = infos[info].information.distanciaTotal

            var dnow = new Date()
            var momentoInicialInicio = filtrarHorario(infos[info].information.momentoInicio)
            var momentoAtualInicio = filtrarHorario(infos[info].information.momentoAtual)

            var momentoFinal = `${dnow.getHours()}:${dnow.getMinutes()}:${dnow.getSeconds()}`

            var momentoDiferencaInicio = calcularMomento(tranformarMomentoSegundos(momentoInicialInicio),
                tranformarMomentoSegundos(momentoFinal))

            var momentoDiferencaAtual = calcularMomento(tranformarMomentoSegundos(momentoAtualInicio),
                tranformarMomentoSegundos(momentoFinal))

            document.getElementById(`velocidade${Number(info) + 1}`).innerHTML = calcularVelocidade(
                Number(infos[info].information.distanciaAtual),
                momentoDiferencaAtual
            )

            document.getElementById(`img${Number(info) + 1}`).src = `/img/competidores/${infos[info].participante.foto}`

            document.getElementById(`pace${Number(info) + 1}`).innerHTML = calcularPace(
                Number(infos[info].information.distanciaTotal),
                momentoDiferencaInicio
            )

        }
    }
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC0xTJ-f4grTeFqo0ORnd83XwKewDLheZE&callback=initMap" async
    defer></script>

</html>