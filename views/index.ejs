<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <!-- CSS -->
    <link rel="stylesheet" href="css/materialize.min.css">
    <link href="css/mobile.css" rel="stylesheet" />

    <!-- Javascript  -->
    <script src="js/jquery.js" type="text/javascript"></script>
    <script src="js/bootstrap.bundle.min.js" type="text/javascript"></script>
    <script src="js/materialize.min.js"></script>

    <!-- Grafico -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

</head>

<body id="mobile" onload="iniciar()">

    <nav class="grey darken-3">
        <div class="nav">
            <a href="/" class="title">ATC LoRa RUN</a>
            <ul class="left">
                <li><i id="back" class="large material-icons">arrow_back</i></li>
            </ul>
        </div>
    </nav>

    <div id="oferecimento" class="row">
        <img src="img/logo-mobile/ATC.png" style="width: 10%">
        <img src="img/logo-mobile/ENET.png" style="width: 6%">
        <img src="img/logo-mobile/lora.png" style="width: 20%">
        <img src="img/logo-mobile/tctec.png" style="width: 20%">
        <img src="img/logo-mobile/BUP.png" style="width: 8%">
    </div>

    <div id="competidores" class="row">
        <div class="col s12 m2">
            <%competidores.forEach((c, i) => {%>
            <div id="estrutura<%- Number(i) + 1%>" class="col s12 m8 offset-m2 l6 offset-l3">
                <div class="card-panel grey lighten-5 z-depth-2 alinhado">
                    <div class="row valign-wrapper">
                        <div class="col s3 " style="padding: 1%">
                            <div class="imagem">
                                <img id="image<%- Number(i) + 1%>" src="img/competidores/generic.png"
                                    class="circle responsive-img">
                                <span class="marcacao circle"><%- Number(i) + 1%>°</span>
                            </div>
                        </div>
                        <div class="col s9">
                            <div class="dados">
                                <span id="number<%- Number(i) + 1%>">

                                </span> -
                                <span id="nome<%- Number(i) + 1%>">
                                    unknown
                                </span>
                                <span id="sobrenome<%- Number(i) + 1%>">

                                </span>
                            </div>
                            <div class="row valign-wrapper date">
                                <div class="col s3 centered">
                                    <i class="align-self-center mr-2 material-icons icone">location_on</i>
                                    <div class="medicao">
                                        <strong id="distancia<%- Number(i) + 1%>">0</strong> <br>
                                        <span id="medicao-dis<%- Number(i) + 1%>">m</span>
                                    </div>
                                </div>
                                <div class="col s3 centered">
                                    <i class="align-self-center mr-2 material-icons icone">directions_run</i>
                                    <div class="medicao">
                                        <strong id="velocidade<%- Number(i) + 1%>">0</strong> <br>
                                        <span>Km/h</span>
                                    </div>
                                </div>
                                <div class="col s3 centered">
                                    <i class="align-self-center mr-2 material-icons icone">whatshot</i>
                                    <div class="medicao">
                                        <strong id="calorias<%- Number(i) + 1%>">0</strong> <br>
                                        <span id="medicao-cal<%- Number(i) + 1%>">cal</span>
                                    </div>
                                </div>
                                <div class="col s3 centered">
                                    <i class="align-self-center mr-2 material-icons icone">favorite_border</i>
                                    <div class="medicao">
                                        <strong id="ritmo<%- Number(i) + 1%>">00:00</strong><br>
                                        <span>min/Km</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <%})%>
        </div>
    </div>

    <div id="informacoes-individuais" class="row">
        <div class="col s12 m6">
            <div class="card">
                <div class="card-image">
                    <div id="map" style="height: 120px"></div>
                </div>
                <div class="card-content" style="padding: 0% 5%; margin: 0% ">
                    <div class="row valign-wrapper" style="padding: 0%;">
                        <div class="col s3" style="padding: 0%; ">
                            <div class="imagem ">
                                <img id="image" src="img/competidores/generic.png" class="circle responsive-img">
                            </div>
                        </div>
                        <div id="detalhesdado" class="col s9" style="padding: 0%;">
                            <h5 style="margin: 0%; text-align:center">
                                <span id="nome">unknown</span>
                                <span id="sobrenome"></span>
                            </h5>
                            <h6 style="margin: 2% 0%; text-align:center"> <span id="position"></span> ° colocado</h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col s12 m6" style="margin-top: 0%">
            <div class="card" style="margin-top: 0%">
                <div id="cardao" class="card-content">
                    <table class="bordered highlight" style="margin-bottom: 2% ">
                        <tbody id="body">
                            <tr>
                                <td>
                                    Distancia
                                    <h5><b id="distancia">0m</b></h5>
                                </td>
                                <td>
                                    Ritmo
                                    <h5><b id="ritmo">00:00</b></h5>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    Tempo Total
                                    <h5><b id="tempototal">0:00:00</b></h5>
                                </td>
                                <td>
                                    Calorias
                                    <h5><b id="calorias">0cal</b></h5>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="center-align">
                <a id="botaoIniciar" class="waves-effect waves-light btn-large"><i class="material-icons left">play_arrow</i>Começar</a>
        </div>
    </div>

</body>
<script>

    var map

    $(document).ready(() => {
        carregar()
    })

    function iniciar() {
        setInterval(carregar, 10000)
    }

    $('.card-panel').click(() => {
        $('#competidores')
            .fadeOut()


        $('#oferecimento')
            .css('display', 'none')


        $('#informacoes-individuais')
            .fadeIn(1500)
            .css('display', 'block')

        $('#back')
            .css('display', 'block')
    })

    $('#back').click(() => {
        $('#competidores')
            .fadeIn()

        $('#informacoes-individuais')
            .css('display', 'none')
            .fadeOut()

        $('#back')
            .css('display', 'none')

        $('#oferecimento')
            .css('display', 'block')
    })

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: -23.5911131, lng: -46.6475914 },
            zoom: 12,
            styles: [{
                "featureType": "poi",
                "stylers": [{
                    "visibility": "off"
                }]
            }],
            scrollwheel: false,
            disableDefaultUI: true
        });
    }
    function iniciarMarcacao(infos) {
        var unique = infos.slice().reverse()

        var ponto = new google.maps.LatLng(unique[0].gps.lat, unique[0].gps.lng)
        var marker = new google.maps.Marker({
            position: ponto,
            map: map,
            title: 'oioio'
        })

    }
    function carregar() {
        $.ajax({
            cache: false,
            url: '/dados/info',
            success: (data) => {

                var { infos, gps, participantes } = data
                let todasInfosCompetidor = []

                for (i in infos) {
                    for (p in participantes) {
                        if (infos[i].devAdress === participantes[p].devAdress) {
                            todasInfosCompetidor.push({ participante: participantes[p], information: infos[i], gps: gps.filter((v) => v.devAdress == participantes[p].devAdress) })
                        }
                    }
                }
                definirColocacao(todasInfosCompetidor)
                plottarDados(todasInfosCompetidor)
            },
            error: (e) => {
                console.error('Error', e)
            }
        })
    }

    function calcularMomento(momento1, momento2) {
        return momento2 - momento1
    }
    function tranformarMomentoSegundos(momento) {
        var tempo = momento.split(':')
        var horas = tempo[0]
        var minutos = tempo[1]

        segundos = (Number(horas) * 3600) + (Number(minutos) * 60) + Number(tempo[2])
        return segundos
    }
    function filtrarHorario(momento) {
        var horas = momento.split('T')
        horas = horas[1].split('.')
        return horas[0]
    }
    function calcularVelocidade(distancia, tempo) {
        if (distancia <= 0 || tempo <= 0) {
            return (0).toFixed(2)
        } else {
            var velocidade = distancia / tempo
            return (velocidade * 3.6).toFixed(1)
        }
    }
    function calcularPace(distancia, tempo) {
        if (distancia <= 0 || tempo <= 0) {
            return `00:00`
        } else {
            var minutos = Number(tempo) / 60
            var quilometros = Number(distancia) / 1000
            var pace = minutos / quilometros
            if (pace < 10) {
                if (((pace * 60) % 60) < 10) {
                    return `0${parseInt(pace)}:0${parseInt(((pace * 60) % 60))}`
                } else {
                    return `0${parseInt(pace)}:${parseInt(((pace * 60) % 60))}`
                }
            } else {
                return `${parseInt(pace)}:${parseInt(((pace * 60) % 60))}`
            }
        }
    }
    function definirColocacao(info) {
        function comparer(a, b) {
            if (a.information.distanciaTotal < b.information.distanciaTotal)
                return 1;

            if (a.information.distanciaTotal > b.information.distanciaTotal)
                return -1;

            return 0;
        }

        info.sort(comparer);

    }
    function formatarDistancia(distancia, index) {

        if (distancia < 0) {
            conectar(`medicao-dis${Number(index) + 1}`, 'm')
            return `${distancia}`
        } else if (distancia < 1000) {
            return `${distancia}`
        } else if (distancia % 1000 == 0) {
            return `${distancia / 1000}`
        } else {
            return `${parseInt(distancia / 1000)}.${parseInt((distancia % 1000) / 10)}`
        }

    }
    function reverterTempo(tempo) {
        if (tempo < 0) return `0:00:00`
        function duas_casas(numero) {
            if (numero <= 9) {
                numero = "0" + numero;
            }
            return numero;
        }
        hora = (Math.round(tempo / 3600));
        minuto = duas_casas(Math.floor((tempo % 3600) / 60));
        segundo = duas_casas((tempo % 3600) % 60);
        formatado = hora + ":" + minuto + ":" + segundo;
        return formatado;
    }
    function calcularCalorias(velocidade, peso, tempo, index = null) {
        var caloria = (parseInt(Number(velocidade) * Number(peso)) * 0.0175) * parseInt(tempo / 60)
        if (caloria >= 1000) {
            if(index) conectar(`medicao-cal${Number(index) + 1}`, 'Kcal')
            return `${parseInt(caloria / 1000)}.${parseInt((caloria % 1000) / 100)}`
        }
        else if (caloria < 0) {
            conectar(`medicao-cal${Number(index) + 1}`, 'cal')
            return `0`
        }
        else {
            conectar(`medicao-cal${Number(index) + 1}`, 'cal')
            return `${parseInt(caloria)}`
        }
    }
    function conectar(id, value, type = 'inner') {
        if (type == 'inner') document.getElementById(id).innerHTML = value
        if (type == 'src') document.getElementById(id).src = value
    }
    function detalharInformacao(posicao, infos) {

        var colocacao = Number(posicao) + 1
        var idEstructure = document.getElementById(`estrutura${colocacao}`)
        var botaoIniciar = document.getElementById(`botaoIniciar`)
        var cadaInfo = infos[posicao]

        let distancia = cadaInfo.information.distanciaTotal,
            peso = infos[info].participante.peso

        var momentoInicialInicio = filtrarHorario(cadaInfo.information.momentoInicio),
            momentoAtualInicio = filtrarHorario(cadaInfo.information.momentoAtual),
            momentoDiferenca = calcularMomento(tranformarMomentoSegundos(momentoInicialInicio),
                tranformarMomentoSegundos(momentoAtualInicio))

        idEstructure.addEventListener('click', () => {
            if (cadaInfo.gps.length != 0) {
                iniciarMarcacao(cadaInfo.gps)
            }
            conectar(`nome`, cadaInfo.participante.nome)
            conectar(`sobrenome`, cadaInfo.participante.sobrenome)
            conectar(`position`, colocacao)
            conectar(`image`, `/img/competidores/${cadaInfo.participante.foto}`, 'src')
            conectar(`distancia`, formatarDistancia(distancia, info))
            conectar(`tempototal`, reverterTempo(momentoDiferenca))
            conectar(`calorias`, calcularCalorias(calcularVelocidade(distancia, momentoDiferenca), peso, momentoDiferenca, posicao))
            conectar(`ritmo`, calcularPace(distancia, momentoDiferenca))

            botaoIniciar.addEventListener('click', () => {
                $.ajax({
                    cache: false,
                    type: 'PUT',
                    url: `/dados/iniciar/${cadaInfo.participante.devAdress}`,
                    success: (data) => {
                        conectar(`distancia`, 0)
                        conectar(`tempototal`, `0:00:00`)
                        conectar(`calorias`, 0)
                        conectar(`ritmo`, 0)
                        console.log(data)
                    }, error: (e) => {
                        console.error(e)
                    }
                })
            })
        })
        


    }
    function plottarDadosMobile(infos) {

        let distancia = infos[info].information.distanciaTotal

        var momentoInicialInicio = filtrarHorario(infos[info].information.momentoInicio),
            momentoAtualInicio = filtrarHorario(infos[info].information.momentoAtual),
            momentoDiferenca = calcularMomento(tranformarMomentoSegundos(momentoInicialInicio),
                tranformarMomentoSegundos(momentoAtualInicio))

        conectar(`nome${Number(info) + 1}`, infos[info].participante.nome)
        conectar(`sobrenome${Number(info) + 1}`, infos[info].participante.sobrenome)
        conectar(`number${Number(info) + 1}`, infos[info].participante.numero)
        conectar(`image${Number(info) + 1}`, `/img/competidores/${infos[info].participante.foto}`, 'src')
        conectar(`distancia${Number(info) + 1}`, formatarDistancia(distancia, info))
        conectar(`velocidade${Number(info) + 1}`, `${calcularVelocidade(distancia, momentoDiferenca)}`)
        conectar(`calorias${Number(info) + 1}`, calcularCalorias(calcularVelocidade(distancia, momentoDiferenca), infos[info].participante.peso, momentoDiferenca, info))
        conectar(`ritmo${Number(info) + 1}`, calcularPace(distancia, momentoDiferenca))

    }
    function plottarDados(infos) {
        for (info in infos) {
            plottarDadosMobile(infos)
            detalharInformacao(info, infos)
        }
    }


</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCER9PMT7J3e41ErfeOyB9MCBCZaELJEQU&callback=initMap" async
    defer></script>

</html>