<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <!-- CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/materialize.min.css">
    <link href="css/dashboard.css" rel="stylesheet" />

    <!-- Javascript  -->
    <script src="js/jquery.js" type="text/javascript"></script>
    <script src="js/bootstrap.bundle.min.js" type="text/javascript"></script>
    <script src="js/materialize.min.js"></script>

    <!-- Grafico -->
    <script src="js/Chart.bundle.min.js"></script>

    <!-- Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="shortcut icon" href="#">

</head>

<body id="dashboard" onload="iniciar()">

    <div id="All" class="container-fluid">
        <div id="items" class="row">
            <div id="cont-twitter" class="col-12">
                <div id="card-twitter" class="card rounded-0 border-dark" style="padding: 0%">
                    <div id="body-twitter" class="card-body" >
                        <div class="row" style="padding: 0%; margin: 0%; height: 100%">
                            <div id="logos-oferecimento" class="col-3" >
                                <h3 style="text-align: center">ATC LoRa RUN</h3>
                                <div id="imagens" >
                                    <div class="row" style="padding-top: 10px">
                                        <div class="col">
                                            <img id="atc" src="img/logo/AmericanTowerLogo.png">
                                        </div>
                                        <div class="col">
                                            <img id="everynet" src="img/logo/Everynet.png">
                                        </div>
                                        <div class="col">
                                            <img id="lora" src="img/logo/lora.png">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <img id="tctec" src="img/logo/tctec.png">
                                        </div>
                                        <div class="col">
                                            <img id="bup" src="img/logo/BottomUp.png">
                                        </div>
                                        <div class="col">
                                            <img id="openlabs" src="img/logo/openlab.png">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-9">
                                <table id="medias">
                                    <tbody>
                                        <tr>
                                            <td style="padding: 0%">
                                                <ul class="lista">
                                                    <li class="infoMedia">
                                                        <i
                                                            class="align-self-center mr-2 material-icons">supervisor_account</i>
                                                        <span><%- competidores.length %></span>
                                                    </li>
                                                    <li class="indiceMedia">
                                                        Pessoas
                                                    </li>
                                                </ul>
                                            </td>
                                            <td style="padding: 0%">
                                                <ul class="lista">
                                                    <li class="infoMedia">
                                                        <i class="align-self-center mr-2 material-icons">location_on</i>
                                                        <span id="distanciaTotal">0m</span>
                                                    </li>
                                                    <li class="indiceMedia">
                                                        Distancia Total
                                                    </li>
                                                </ul>
                                            </td>
                                            <td style="padding: 0%">
                                                <ul class="lista">
                                                    <li class="infoMedia">
                                                        <i
                                                            class="align-self-center mr-2 material-icons">directions_run</i>
                                                        <span id="velocidadeMedia">0km/h</span>
                                                    </li>
                                                    <li class="indiceMedia">
                                                        Velocidade Media
                                                    </li>
                                                </ul>
                                            </td>
                                            <td style="padding: 0%">
                                                <ul class="lista" style="padding: 0%">
                                                    <li class="infoMedia">
                                                        <i class="align-self-center mr-2 material-icons">whatshot</i>
                                                        <span id="caloriaTotal">0cal</span>
                                                    </li>
                                                    <li class="indiceMedia">
                                                        Caloria Total
                                                    </li>
                                                </ul>
                                            </td>
                                            <td style="padding: 0%">
                                                <ul class="lista">
                                                    <li class="infoMedia">
                                                        <i
                                                            class="align-self-center mr-2 material-icons">favorite_border</i>
                                                        <span id="ritmoMedio">00:00</span>
                                                    </li>
                                                    <li class="indiceMedia">
                                                        Ritmo Medio
                                                    </li>
                                                </ul>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        <div id="graph" class="row">
            <div id="cont-dash" class="col-12">
                <div id="card-dash" class="card rounded-0 border-dark">
                    <!-- <div id="header-dash" class="card-header rounded-0 border-danger">
                        <h5 class="card-title">Competidores</h5>
                    </div> -->
                    <!-- head -->
                    <div id="body-dash" class="card-body">
                        <table id="tabela" class="table">
                            <!-- body -->
                            <tbody style=" border-top: 2px solid #d9534f;">
                                <tr class="border-0">

                                    <% for(competidor in competidores) {  %>

                                    <td class="border border-left-0 border-danger pessoa">
                                        <div class="media">
                                            <div class="imagem">
                                                <img id="img<%- Number(competidor) + 1%>"
                                                    src="img/competidores/generic.png"
                                                    class="figure-img img-fluid mr-0">
                                                <div class="colocacao">
                                                    <%- Number(competidor)+1 %>Â°
                                                </div>
                                            </div>
                                            <div class="media-body">
                                                <div id="nome<%- Number(competidor) + 1%>" class="nome">
                                                    Unknown
                                                </div>
                                                <div id="sobrenome<%- Number(competidor) + 1%>" class="sobrenome">
                                                    Unknown
                                                </div>
                                            </div>
                                        </div>
                                    </td>

                                    <td class="dado border border-danger">
                                        <div class="row dados">
                                            <div class="col-3 coluna">
                                                <div class="media mt-2">
                                                    <ul class="lista">
                                                        <li class="media">
                                                            <i style="color:#673ab7"
                                                                class="align-self-center mr-2 material-icons icone">location_on</i>
                                                            <div class="media-body">
                                                                <span
                                                                    id="distancia<%- Number(competidor) + 1%>">0m</span>
                                                            </div>
                                                        </li>
                                                        <li class="descricao">
                                                            Distancia
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>

                                            <div class="col-3">
                                                <div class="media mt-2" style="margin-right: 200px">
                                                    <ul class="lista">
                                                        <li class="media">
                                                            <i style="color:#f4511e"
                                                                class="align-self-center mr-2 material-icons icone">directions_run</i>
                                                            <div class="media-body">
                                                                <span
                                                                    id="velocidade<%- Number(competidor) + 1%>">0.00</span>
                                                            </div>
                                                        </li>
                                                        <li class="descricao">
                                                            Velocidade
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>

                                            <div class="col-3 proximas">
                                                <div class="media mt-2">
                                                    <ul class="lista">
                                                        <li class="media ritmo">
                                                            <i style="color:#eeff41"
                                                                class="align-self-center mr-2 material-icons icone">whatshot</i>
                                                            <div class="media-body">
                                                                <span
                                                                    id="calorias<%- Number(competidor) + 1%>">0kcal</span>
                                                            </div>
                                                        </li>
                                                        <li class="descricao">
                                                            Calorias / Min
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>

                                            <div class="col-3 proximas">
                                                <div class="media dados mt-2">
                                                    <ul class="lista">
                                                        <li class="media ritmo">
                                                            <i style="color:#4caf50"
                                                                class="align-self-center mr-2 material-icons icone">favorite_border</i>
                                                            <div class="media-body">
                                                                <span
                                                                    id="ritmo<%- Number(competidor) + 1%>">00:00</span>
                                                            </div>
                                                        </li>
                                                        <li class="descricao">
                                                            Ritmo
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="border border-danger">
                                        <div class="bar">
                                            <canvas id="graphBar<%- Number(competidor) + 1%>" height=55></canvas>
                                        </div>
                                    </td>
                                </tr>
                                <%}%>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>

<script>

    var map

    $(document).ready(() => {
        carregar()
    })

    function iniciar() {
        setInterval(carregar, 10000)
    }

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: -23.5911131, lng: -46.6475914 },
            zoom: 12,
            styles: [{
                "featureType": "poi",
                "stylers": [{
                    "visibility": "off"
                }]
            }],
            scrollwheel: false,
            disableDefaultUI: true
        });

    }

    function plottarGrafico(id, data) {

        new Chart(document.getElementById(id).getContext('2d'), {

            type: 'horizontalBar',
            data: {
                labels: ["Distancia (Km)", "Velocidade (Km/h)", "Calorias (cal)", "Ritmo (min)"],
                datasets: [
                    {
                        backgroundColor: ["#673ab7", "#f4511e", "#eeff41", "#4caf50"],
                        data: data,
                    }
                ]
            },
            options: {
                legend: { display: false },
                title: {
                    display: false,
                },
                scales: {
                    yAxes: [{
                        display: false,
                        barThickness: 15,
                        stacked: true,
                        minBarLength: 200
                    }],
                    xAxes: [{
                        display: false,
                        stacked: true
                    }],
                },
                animation: {
                    duration: 0 // general animation time
                },
                hover: {
                    animationDuration: 0 // duration of animations when hovering an item
                },
                responsiveAnimationDuration: 0
            }
        });
    }

    // Variaveis Globais
    var pace = 0
    var Velocidade = 0
    var markers = [];
    // Cores
    var cores = ['#FFFFFF', '#FF0000', '#00FF00', '#0000FF', '#FF00FF', '#00FFFF', '#FF7F00', '#99CC32', '#D8D8BF', '#00009C', '#871F78', '#007FFF', '#FF1493', '#DC143C', '#2F4F4F', '#1E90FF', '#836FFF', '#BA55D3', '#FF7F50', '#B0E0E6', '#8B0000', '#50C878', '#831D1C', '#78866B', '#6B8E23', '#8FBC8F', '#FF00FF', '#FBEC5D', '#E9967A', '#008080']


    function iniciarMarcacao(infos, color) {

        var unique = infos.slice().reverse()

        var balao = {
            path: 'M10.292,4.229c-1.487,0-2.691,1.205-2.691,2.691s1.205,2.691,2.691,2.691s2.69-1.205,2.69-2.691S11.779,4.229,10.292,4.229z M10.292,8.535c-0.892,0-1.615-0.723-1.615-1.615S9.4,5.306,10.292,5.306c0.891,0,1.614,0.722,1.614,1.614S11.184,8.535,10.292,8.535z M10.292,1C6.725,1,3.834,3.892,3.834,7.458c0,3.567,6.458,10.764,6.458,10.764s6.458-7.196,6.458-10.764C16.75,3.892,13.859,1,10.292,1z M4.91,7.525c0-3.009,2.41-5.449,5.382-5.449c2.971,0,5.381,2.44,5.381,5.449s-5.381,9.082-5.381,9.082S4.91,10.535,4.91,7.525z',
            strokeColor: cores[color],
            fillColor: cores[color],
            fillOpacity: 0.8,
            scale: 1,
            strokeWeight: 0.1,
            scale: 2,
        }

        var ponto = new google.maps.LatLng(unique[0].gps.lat, unique[0].gps.lng)
        var marker = new google.maps.Marker({
            position: ponto,
            map: map,
            icon: balao
        })
    }


    function carregar() {
        $.ajax({
            cache: false,
            url: '/dados/info',
            success: (dados) => {

                var todasInfosCompetidor = []

                let { participantes, infos, gps } = dados

                for (dado in participantes) {
                    for (info in infos) {
                        if (participantes[dado].devAdress == infos[info].devAdress) {
                            var gpsFiltered = gps.filter((value) => {
                                return value.devAdress === participantes[dado].devAdress
                            })
                            todasInfosCompetidor.push({ participante: participantes[dado], information: infos[info], gps: gpsFiltered })
                        }
                    }
                }

                definirColocacao(todasInfosCompetidor)
                plottarDados(todasInfosCompetidor)

            },
            error: (e) => {
                console.error('Error', e)
            }
        })
    }

    function calcularMomento(momento1, momento2) {
        return momento2 - momento1
    }

    function tranformarMomentoSegundos(momento) {
        var tempo = momento.split(':')
        var horas = tempo[0]
        var minutos = tempo[1]

        segundos = (Number(horas) * 3600) + (Number(minutos) * 60) + Number(tempo[2])
        return segundos
    }

    function filtrarHorario(momento) {
        var horas = momento.split('T')
        horas = horas[1].split('.')
        return horas[0]
    }

    function formatarDistancia(distancia) {

        if (distancia < 0) {
            return `${distancia}m`
        } else if (distancia < 1000) {
            return `${distancia}m`
        } else if (distancia % 1000 == 0) {
            return `${distancia / 1000}km`
        } else {
            return `${parseInt(distancia / 1000)}.${parseInt((distancia % 1000) / 100)}km`
        }

    }

    function calcularVelocidade(distancia, tempo) {
        if (distancia <= 0 || tempo <= 0) {
            return (0).toFixed(2)
        } else {
            var velocidade = distancia / tempo
            return (velocidade * 3.6).toFixed(2)
        }
    }

    function calcularPace(distancia, tempo) {
        if (distancia <= 0 || tempo <= 0) {
            return `00:00`
        } else {
            var minutos = Number(tempo) / 60
            var quilometros = Number(distancia) / 1000
            var pace = minutos / quilometros
            if (pace < 10) {
                if (((pace * 60) % 60) < 10) {
                    return `0${parseInt(pace)}:0${parseInt(((pace * 60) % 60))}`
                } else {
                    return `0${parseInt(pace)}:${parseInt(((pace * 60) % 60))}`
                }
            } else {
                return `${parseInt(pace)}:${parseInt(((pace * 60) % 60))}`
            }
        }
    }
    function calcularCalorias(velocidade, peso, tempo) {
        var caloria = (parseInt(Number(velocidade) * Number(peso)) * 0.0175) * parseInt(tempo / 60)
        return caloria
    }
    function formatarCalorias(caloria) {
        if (caloria >= 1000) return `${parseInt(caloria / 1000)}.${parseInt((caloria % 1000) / 100)}Kcal`
        else if (caloria < 0) return `0cal`
        else return `${parseInt(caloria)}cal`
    }
    function definirColocacao(info) {
        function comparer(a, b) {
            if (a.information.distanciaTotal < b.information.distanciaTotal) {
                return 1;
            }
            if (a.information.distanciaTotal > b.information.distanciaTotal) {
                return -1;
            }
        }
        function comparerStatus(a, b) {
            if (a.information.status < b.information.status) {
                return 1;
            }
            if (a.information.status > b.information.status) {
                return -1;
            }
        }
        function comparerTempo(a, b) {
            if (a.information.status === 100 && b.information.status === 100) {
                let diferencaTempoA = calcularMomento(tranformarMomentoSegundos(filtrarHorario(a.information.momentoInicio)), tranformarMomentoSegundos(filtrarHorario(a.information.momentoAtual)))
                let diferencaTempoB = calcularMomento(tranformarMomentoSegundos(filtrarHorario(b.information.momentoInicio)), tranformarMomentoSegundos(filtrarHorario(b.information.momentoAtual)))
                if (diferencaTempoB < diferencaTempoA) {
                    return 1;
                }
                if (diferencaTempoB > diferencaTempoA) {
                    return -1;
                }
            }
            return 0;
        }

        info.sort(comparer).sort(comparerStatus).sort(comparerTempo);
    }

    function conectar(id, value, type = 'inner') {
        if (type == 'inner') document.getElementById(id).innerHTML = value
        if (type == 'src') document.getElementById(id).src = value
    }

    function converterRitmo(ritmo) {
        var momento = ritmo.split(':')
        var minutos = Number(momento[0])
        var segundos = Number(momento[1])

        return minutos * 60 + segundos
    }
    function formatarParaRitmo(pace) {
        if (pace < 10) {
            if (((pace * 60) % 60) < 10) {
                return `0${parseInt(pace)}:0${parseInt(((pace * 60) % 60))}`
            } else {
                return `0${parseInt(pace)}:${parseInt(((pace * 60) % 60))}`
            }
        } else {
            return `${parseInt(pace)}:${parseInt(((pace * 60) % 60))}`
        }

        return `00:00`
    }

    function plottarDados(infos) {

        var velocidadeTotal = 0, caloriaTotal = 0, distanciaTotal = 0, ritmoTotal = 0, cont = 0

        for (info in infos) {
            if (infos[info].gps.length != 0) {
                iniciarMarcacao(infos[info].gps, infos[info].participante.corPin)
            }

            var momentoInicialInicio = filtrarHorario(infos[info].information.momentoInicio),
                momentoAtualInicio = filtrarHorario(infos[info].information.momentoAtual),
                distancia = infos[info].information.distanciaTotal,
                momentoDiferenca = calcularMomento(tranformarMomentoSegundos(momentoInicialInicio),
                    tranformarMomentoSegundos(momentoAtualInicio))

            let velocidade = Number(calcularVelocidade(distancia, momentoDiferenca)),
                calorias = calcularCalorias(velocidade, infos[info].participante.peso, momentoDiferenca),
                ritmo = calcularPace(distancia, momentoDiferenca)

            conectar(`img${Number(info) + 1}`, `/img/competidores/${infos[info].participante.foto}`, 'src')
            conectar(`nome${Number(info) + 1}`, infos[info].participante.nome)
            conectar(`sobrenome${Number(info) + 1}`, infos[info].participante.sobrenome)
            conectar(`distancia${Number(info) + 1}`, formatarDistancia(distancia))
            conectar(`calorias${Number(info) + 1}`, formatarCalorias(Number(calorias)))
            conectar(`velocidade${Number(info) + 1}`, (velocidade).toFixed(2))
            conectar(`ritmo${Number(info) + 1}`, ritmo)

            let { status } = infos[info].information

            if (status === 0) {
                $(`#nome${Number(info) + 1}`).css('color', '#ff5252')
                $(`#sobrenome${Number(info) + 1}`).css('color', '#ff5252')
            }
            if (status === 99) {
                $(`#nome${Number(info) + 1}`).css('color', '#f9a825')
                $(`#sobrenome${Number(info) + 1}`).css('color', '#f9a825')
            }
            if (status === 100) {
                $(`#nome${Number(info) + 1}`).css('color', '#00c853')
                $(`#sobrenome${Number(info) + 1}`).css('color', '#00c853')
            }

            velocidadeTotal += velocidade
            distanciaTotal += distancia
            caloriaTotal += Number(calorias)
            ritmoTotal += converterRitmo(ritmo)

            cont++

            let segundosRitmo = converterRitmo(ritmo)

            plottarGrafico(`graphBar${Number(info) + 1}`, [distancia, velocidade * 1000, Number(calorias), (segundosRitmo).toFixed(2)])
        }

        conectar('distanciaTotal', formatarDistancia(distanciaTotal))
        conectar('caloriaTotal', formatarCalorias(caloriaTotal))

        conectar('velocidadeMedia', `${(velocidadeTotal / infos.length).toFixed(2)}Km/h`)
        conectar('ritmoMedio', formatarParaRitmo((ritmoTotal / 60) / infos.length))

    }



</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAhS0HbkkKiUf2BV1T_skrfb2Pw63XzPeI&callback=initMap" async
    defer></script>

</html>