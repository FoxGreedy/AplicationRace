<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <!-- CSS -->
    <link href="css/index.css" rel="stylesheet" />
    <link href="css/bootstrap.min.css" rel="stylesheet" />

    <!-- Javascript  -->
    <script src="js/jquery.js" type="text/javascript"></script>
    <script src="js/bootstrap.bundle.min.js" type="text/javascript"></script>
    <script src="js/bootstrap-dash.js"></script>
    <script src="js/scrollbarEffect.js"></script>

    <!-- Grafico -->
    <script src="js/Chart.bundle.min.js"></script>

    <!-- Maps -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC0xTJ-f4grTeFqo0ORnd83XwKewDLheZE&callback=initMap"
        async defer></script>


</head>

<body id="home" onload="carregar()">

    <div id="container" style="height: 100%; position: absolute;">

        <!-- Logo -->
        <div>
            <div id="logo">
                <img src="img/AmericanTowerLogo.png">
            </div>
        </div>

        <div id="content" class="col-md-12">
            <!-- Map -->
            <div id="estmapa" class="row">
                <div id="mapa" class="col-md-12">
                    <div id="map" style="height: 100%"></div>
                </div>
            </div>
        </div>

        <!-- Card - Conteudo1 -->
        <div id="conteudo1" class="row justify-content-end">
            <div id="lateral1" class="col-md-4">
                <div id="cartao-lateral" class="card text-white">
                    <div class="card-header">
                        <div class="card-title">
                            <h3>Twitter</h3>
                        </div>
                    </div>
                    <div id="" class="card-body">

                    </div>
                </div>
            </div>
            <div id="baixo" class="col-md-12">
                <div id="cartao-baixo" class="card text-white">
                    <div id="Info-competidores" class="card-body">
                        <div class="row">
                            <div class="col-md info-competidor">
                                <div class="media">
                                    <img class="rounded-circle" class="align-self-start mr-3" src="./img/generic.png"
                                        alt="Imagem de exemplo genérica" style="width: 80px; margin-right: 10px">
                                    <div class="media-body">
                                        <h5 class="mt-0">1° Colocado</h5>
                                        <h6 class="mt-0" id="nome1"></h6>
                                        <h6 class="mt-0">Equipe: <span id="equipe1"></span></h6>
                                    </div>
                                </div>
                                <b>Distância percorrida: </b><span id="distancia1">0</span> Km <br>
                                <b>Velocidade Atual: </b><span id="velocidade1">0</span> Km/H <br>
                                <b>Pace Atual: </b><span id="pace1">0</span> mm/Km <br>
                            </div>
                            <div class="col-md info-competidor">
                                <div class="media">
                                    <img class="rounded-circle" class="align-self-start mr-3" src="./img/generic.png"
                                        alt="Imagem de exemplo genérica" style="width: 80px; margin-right: 10px">
                                    <div class="media-body">
                                        <h5 class="mt-0">2° Colocado</h5>
                                        <h6 class="mt-0" id="nome2"></h6>
                                        <h6 class="mt-0">Equipe: <span id="equipe2"></span></h6>
                                    </div>
                                </div>
                                <b>Distância percorrida: </b><span id="distancia2">0</span> Km <br>
                                <b>Velocidade Atual: </b><span id="velocidade2">0</span> Km/H <br>
                                <b>Pace Atual: </b><span id="pace2">0</span> mm/Km <br>
                            </div>
                            <div class="col-md info-competidor">
                                <div class="media">
                                    <img class="rounded-circle" class="align-self-start mr-3" src="./img/generic.png"
                                        alt="Imagem de exemplo genérica" style="width: 80px; margin-right: 10px">
                                    <div class="media-body">
                                        <h5 class="mt-0">3° Colocado</h5>
                                        <h6 class="mt-0" id="nome3"></h6>
                                        <h6 class="mt-0">Equipe: <span id="equipe3"></span></h6>
                                    </div>
                                </div>
                                <b>Distância percorrida: </b><span id="distancia3">0</span> Km <br>
                                <b>Velocidade Atual: </b><span id="velocidade3">0</span> Km/H <br>
                                <b>Pace Atual: </b><span id="pace3">0</span> mm/Km <br>
                            </div>
                            <div class="col-md info-competidor">
                                <div class="media">
                                    <img class="rounded-circle" class="align-self-start mr-3" src="./img/generic.png"
                                        alt="Imagem de exemplo genérica" style="width: 80px; margin-right: 10px">
                                    <div class="media-body">
                                        <h5 class="mt-0">4° Colocado</h5>
                                        <h6 class="mt-0" id="nome4"></h6>
                                        <h6 class="mt-0">Equipe: <span id="equipe4"></span></h6>
                                    </div>
                                </div>
                                <b>Distância percorrida: </b><span id="distancia4">0</span> Km <br>
                                <b>Velocidade Atual: </b><span id="velocidade4">0</span> Km/H <br>
                                <b>Pace Atual: </b><span id="pace4">0</span> mm/Km <br>
                            </div>
                            <div class="col-md info-competidor">
                                <div class="media">
                                    <img class="rounded-circle" class="align-self-start mr-3" src="./img/generic.png"
                                        alt="Imagem de exemplo genérica" style="width: 80px; margin-right: 10px">
                                    <div class="media-body">
                                        <h5 class="mt-0">5° Colocado</h5>
                                        <h6 class="mt-0" id="nome5"></h6>
                                        <h6 class="mt-0">Equipe: <span id="equipe5"></span></h6>
                                    </div>
                                </div>
                                <b>Distância percorrida: </b><span id="distancia5">0</span> Km <br>
                                <b>Velocidade Atual: </b><span id="velocidade5">0</span> Km/H <br>
                                <b>Pace Atual: </b><span id="pace5">0</span> mm/Km <br>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Fim card Conteudo1 -->

        <!-- Inicio card Conteudo2 -->

        <div id="conteudo2" class="row justify-content-end">
            <div id="lateral2" class="col-md-4">
                <div id="cartao-lateral" class="card text-white">
                    <div id="" class="card-body">
                        <div class="col-md">
                            <div class="media">
                                <img class="rounded-circle" class="align-self-start mr-3" src="./img/generic.png"
                                    alt="Imagem de exemplo genérica" style="width: 120px; margin-right: 10px">
                                <div class="media-body">
                                    <h3 class="mt-0">5° Colocado</h3>
                                    <h4 class="mt-0">Leandro Nunes</h4>
                                    <h4 class="mt-0">Equipe: <span>XX</span> </h4>
                                </div>
                            </div>
                            <b>Distância percorrida: </b><span>0</span> Km <br>
                            <b>Velocidade Atual: </b><span>0</span> Km/H <br>
                            <b>Pace Atual: </b><span>0</span> mm/Km <br>

                            <canvas id="chart1" height="160" style="margin-top: 10px"></canvas>
                            <canvas id="chart2" height="160"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Fim card Conteudo2 -->
    </div>

</body>

<script>

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: -23.5911131, lng: -46.6475914 },
            zoom: 15,
            styles: [{
                "featureType": "poi",
                "stylers": [{
                    "visibility": "off"
                }]
            }],
            scrollwheel: false,
            disableDefaultUI: true
        });
    }

    function plottarGrafico(id) {

        new Chart(document.getElementById(id), {
            type: 'bar',
            data: {
                labels: ["1900", "1950", "1999", "2050"],
                datasets: [
                    {
                        label: "Africa",
                        backgroundColor: 'blue',
                        data: [133, 221, 783, 2478]
                    }, {
                        label: "Europe",
                        backgroundColor: "orange",
                        data: [408, 547, 675, 734]
                    }
                ]
            },
            options: {
                title: {
                    display: true,
                    text: 'Population growth (millions)',
                    fontColor: '#fff'

                },
                legend: {
                    labels: {
                        fontColor: '#fff'
                    },
                    fontColor: '#fff'
                }
            }
        });
    }

    // Variaveis Globais
    var pace = 0
    var Velocidade = 0

    // Começo algoritmo corrida

    $(document).ready(() => {
        plottarGrafico('chart1')
        plottarGrafico('chart2')
    })

    function posicionarMarcadoresMapa() {

    }

    function carregar() {
        $.ajax({
            cache: false,
            url: '/dados/info',
            success: (dados) => {

                var todasInfosCompetidor = []

                let { participantes } = dados
                let { infos } = dados

                for (dado in participantes) {
                    pegarUltimosDadosGPS(participantes[dado].devAdress, participantes[dado].nome)
                    for (info in infos) {
                        if (participantes[dado].nome == infos[info].nomeCompetidor) {
                            todasInfosCompetidor.push({ participante: participantes[dado], information: infos[info] })
                        }
                    }
                }

                definirColocacao(todasInfosCompetidor)
                plottarDados(todasInfosCompetidor)
                console.log(todasInfosCompetidor)
            },
            error: (e) => {
                console.error('Error', e)
            }
        })
    }

    function pegarUltimosDadosGPS(device, nome) {
        $.ajax({
            cache: false,
            url: `historico/${device}`,
            success: (dados) => {
                let { gps } = dados
                atualizarDados(nome, pegarDistancia(gps.ultimo.gps, gps.penultimo.gps))
            }
        })
    }

    function pegarDistancia(ultima, penultima) {
        "use strict";
        var deg2rad = function (deg) { return deg * (Math.PI / 180); },
            R = 6371,
            dLat = deg2rad(penultima.lat - ultima.lat),
            dLng = deg2rad(penultima.lng - ultima.lng),
            a = Math.sin(dLat / 2) * Math.sin(dLat / 2)
                + Math.cos(deg2rad(ultima.lat))
                * Math.cos(deg2rad(ultima.lat))
                * Math.sin(dLng / 2) * Math.sin(dLng / 2),
            c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return ((R * c * 1000).toFixed());
    }

    function calcularVelocidade(momento, distancia) {

    }

    function calcularPace(momento, distancia) {

    }

    function atualizarDados(nome, distancia) {

        dado = {
            distancia: distancia
        }

        $.ajax({
            url: `dados/${nome}`,
            type: 'PUT',
            data: dado,
            success: (data) => {
                console.log('Dado atualizado com sucesso')
            },
            error: (e) => {
                console.error('Error', e)
            }
        })
    }

    function definirColocacao(info) {

        function comparer(a, b) {
            if (a.information.distancia < b.information.distancia)
                return -1;

            if (a.information.distancia > b.information.distancia)
                return 1;

            return 0;
        }

        info.sort(comparer);

    }

    function plottarDados(infos) {
        for(info in infos){
            document.getElementById(`nome${Number(info) + 1}`).innerHTML = infos[info].participante.nome
            document.getElementById(`equipe${Number(info) + 1}`).innerHTML = infos[info].participante.equipe

            document.getElementById(`distancia${Number(info) + 1}`).innerHTML = infos[info].information.distancia
        }
    }


</script>

</html>