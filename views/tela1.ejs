<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <!-- CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/materialize.min.css">
    <link href="css/index.css" rel="stylesheet" />

    <!-- Javascript  -->
    <script src="js/jquery.js" type="text/javascript"></script>
    <script src="js/bootstrap.bundle.min.js" type="text/javascript"></script>
    <script src="js/bootstrap-dash.js"></script>
    <script src="js/scrollbarEffect.js"></script>
    <script src="js/materialize.min.js"></script>

    <!-- Grafico -->
    <script src="js/Chart.bundle.min.js"></script>

    <!-- Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="shortcut icon" href="#">

</head>

<body id="home" onload="iniciar()">

    <div id="container" style="height: 100%; position: absolute;">

        <!-- Logo -->
        <div>
            <div class="logo">
                <img id="atc" src="img/logo/AmericanTowerLogo.png">
                <img id="everynet" src="img/logo/Everynet.png">
                <img id="lora" src="img/logo/lora.png">
                <img id="tctec" src="img/logo/tctec.png">
                <img id="bup" src="img/logo/BottomUp.png">
            </div>
        </div>

        <div id="content" class="col-md-12">
            <!-- Map -->
            <div id="estmapa" class="row">
                <div id="mapa" class="col-md-12">
                    <div id="map"></div>
                </div>
            </div>
        </div>


        <div id="conteudo">
            <div class="fileira">
                <div id="linha" class="row">
                    <div class="col-sm">
                        <div class="card border-dark bg-danger rounded-0 text-white">
                            <div id="head1" class="card-header">
                                <div class="media">
                                    <img id="img1" src="./img/competidores/generic.png"
                                        class="rounded-circle mx-auto d-block border border-dark">
                                    <div class="media-body" style="font-size: 15px;">
                                        <h5
                                            style="text-align: center; margin-top: 10px; margin-left: 65px; font-size: 20px; text-align: center">
                                            1° <span id="nome1"></span>
                                            <i id="icone1"
                                                class="align-self-center mr-2 small material-icons">location_on</i>
                                        </h5>
                                    </div>
                                </div>
                            </div>
                            <div id="body1" class="card-body">

                                <ul class="list-unstyled" style="margin-bottom: 0%; margin-top: 2%; margin-left: 2%;">
                                    <li class="media">
                                        <i class="align-self-center mr-2 small material-icons">location_on</i>
                                        <div class="media-body" style="font-size: 15px;">
                                            <b class="mt-1 mb-1">Distancia Total (m)</b> <br>
                                            <span id="distancia1">0</span>
                                        </div>
                                    </li>
                                    <li class="media my-4">
                                        <i class="align-self-center mr-2 small material-icons">directions_run</i>
                                        <div class="media-body" style="font-size: 15px">
                                            <b class="mt-1 mb-1">Velocidade (Km/h)</b> <br>
                                            <span id="velocidade1">0.00</span>
                                        </div>
                                    </li>
                                    <li class="media">
                                        <i class="align-self-center mr-2 small material-icons">favorite_border</i>
                                        <div class="media-body" style="font-size: 15px">
                                            <b class="mt-1 mb-1">Ritmo (Minutos/Km)</b> <br>
                                            <span id="pace1">0</span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm">
                        <div class="card bg-danger rounded-0 border-dark text-white">
                            <div id="head2" class="card-header">
                                <img id="img2" src="./img/competidores/generic.png"
                                    class="rounded-circle mx-auto d-block border border-dark">
                                <div class="media-body" style="font-size: 15px;">
                                    <h5
                                        style="text-align: center; margin-top: 10px; margin-left: 65px; font-size: 20px; text-align: center">
                                        2° <span id="nome2"></span>
                                        <i id="icone2"
                                            class="align-self-center mr-2 small material-icons">location_on</i>
                                    </h5>
                                </div>
                            </div>
                            <div id="body2" class="card-body ">
                                <ul class="list-unstyled" style="margin-bottom: 0%; margin-top: 2%; margin-left: 2%;">
                                    <li class="media">
                                        <i class="align-self-center mr-2 small material-icons">location_on</i>
                                        <div class="media-body" style="font-size: 15px;">
                                            <b class="mt-1 mb-1">Distancia Total (m)</b> <br>
                                            <span id="distancia2">0</span>
                                        </div>
                                    </li>
                                    <li class="media my-4">
                                        <i class="align-self-center mr-2 small material-icons">directions_run</i>
                                        <div class="media-body" style="font-size: 15px">
                                            <b class="mt-1 mb-1">Velocidade (Km/h)</b> <br>
                                            <span id="velocidade2">0.00</span>
                                        </div>
                                    </li>
                                    <li class="media">
                                        <i class="align-self-center mr-2 small material-icons">favorite_border</i>
                                        <div class="media-body" style="font-size: 15px">
                                            <b class="mt-1 mb-1">Ritmo (Minutos/Km)</b> <br>
                                            <span id="pace2">0</span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm">
                        <div class="card bg-danger rounded-0 border-dark text-white">
                            <div id="head3" class="card-header">
                                <img id="img1" src="./img/competidores/generic.png"
                                    class="rounded-circle mx-auto d-block border border-dark">

                                <div class="media-body" style="font-size: 15px;">
                                    <h5
                                        style="text-align: center; margin-top: 10px; margin-left: 65px; font-size: 20px; text-align: center">
                                        3° <span id="nome3"></span>
                                        <i id="icone3"
                                            class="align-self-center mr-2 small material-icons">location_on</i>
                                    </h5>
                                </div>
                            </div>
                            <div id="body3" class="card-body">
                                <ul class="list-unstyled" style="margin-bottom: 0%; margin-top: 2%; margin-left: 2%;">
                                    <li class="media">
                                        <i class="align-self-center mr-2 small material-icons">location_on</i>
                                        <div class="media-body" style="font-size: 15px;">
                                            <b class="mt-1 mb-1">Distancia Total (m)</b> <br>
                                            <span id="distancia3">0</span>
                                        </div>
                                    </li>
                                    <li class="media my-4">
                                        <i class="align-self-center mr-2 small material-icons">directions_run</i>
                                        <div class="media-body" style="font-size: 15px">
                                            <b class="mt-1 mb-1">Velocidade (Km/h)</b> <br>
                                            <span id="velocidade3">0.00</span>
                                        </div>
                                    </li>
                                    <li class="media">
                                        <i class="align-self-center mr-2 small material-icons">favorite_border</i>
                                        <div class="media-body" style="font-size: 15px">
                                            <b class="mt-1 mb-1">Ritmo (Minutos/Km)</b> <br>
                                            <span id="pace3">0</span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm">
                        <div class="card bg-danger rounded-0 border-dark text-white">
                            <div id="head4" class="card-header">
                                <img id="img4" src="./img/competidores/generic.png"
                                    class="rounded-circle mx-auto d-block border border-dark">

                                <div class="media-body" style="font-size: 15px;">
                                    <h5
                                        style="text-align: center; margin-top: 10px; margin-left: 65px; font-size: 20px; text-align: center">
                                        4° <span id="nome4"></span>
                                        <i id="icone4"
                                            class="align-self-center mr-2 small material-icons">location_on</i>
                                    </h5>
                                </div>
                            </div>
                            <div id="body4" class="card-body text-white" style="font-size: 15px">
                                <ul class="list-unstyled" style="margin-bottom: 0%; margin-top: 2%; margin-left: 2%;">
                                    <li class="media">
                                        <i class="align-self-center mr-2 small material-icons">location_on</i>
                                        <div class="media-body" style="font-size: 15px;">
                                            <b class="mt-1 mb-1">Distancia Total (m)</b> <br>
                                            <span id="distancia4">0</span>
                                        </div>
                                    </li>
                                    <li class="media my-4">
                                        <i class="align-self-center mr-2 small material-icons">directions_run</i>
                                        <div class="media-body" style="font-size: 15px">
                                            <b class="mt-1 mb-1">Velocidade (Km/h)</b> <br>
                                            <span id="velocidade4">0.00</span>
                                        </div>
                                    </li>
                                    <li class="media">
                                        <i class="align-self-center mr-2 small material-icons">favorite_border</i>
                                        <div class="media-body" style="font-size: 15px">
                                            <b class="mt-1 mb-1">Ritmo (Minutos/Km)</b> <br>
                                            <span id="pace4">0</span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm">
                        <div class="card bg-danger rounded-0 border-dark text-white">
                            <div id="head5" class="card-header">
                                <img id="img5" src="./img/competidores/generic.png"
                                    class="rounded-circle mx-auto d-block border border-dark">

                                <div class="media-body" style="font-size: 15px;">
                                    <h5
                                        style="text-align: center; margin-top: 10px; margin-left: 65px; font-size: 20px; text-align: center">
                                        5° <span id="nome5"></span>
                                        <i id="icone5"
                                            class="align-self-center mr-2 small material-icons">location_on</i>
                                    </h5>
                                </div>
                            </div>
                            <div id="body5" class="card-body  text-white">
                                <ul class="list-unstyled" style="margin-bottom: 0%; margin-top: 2%; margin-left: 2%;">
                                    <li class="media">
                                        <i class="align-self-center mr-2 small material-icons">location_on</i>
                                        <div class="media-body" style="font-size: 15px;">
                                            <b class="mt-1 mb-1">Distancia Total (m)</b> <br>
                                            <span id="distancia5">0</span>
                                        </div>
                                    </li>
                                    <li class="media my-4">
                                        <i class="align-self-center mr-2 small material-icons">directions_run</i>
                                        <div class="media-body" style="font-size: 15px">
                                            <b class="mt-1 mb-1">Velocidade (Km/h)</b> <br>
                                            <span id="velocidade5">0.00</span>
                                        </div>
                                    </li>
                                    <li class="media">
                                        <i class="align-self-center mr-2 small material-icons">favorite_border</i>
                                        <div class="media-body" style="font-size: 15px">
                                            <b class="mt-1 mb-1">Ritmo (Minutos/Km)</b> <br>
                                            <span id="pace5">0</span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>



</body>

<script>

    $(document).ready(() => {
        carregar()
    })

    function iniciar() {
        setInterval(carregar, 10000)
    }

    var map

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: -23.5911131, lng: -46.6475914 },
            zoom: 12,
            styles: [{
                "featureType": "poi",
                "stylers": [{
                    "visibility": "off"
                }]
            }],
            scrollwheel: false,
            disableDefaultUI: true
        });
    }

    function plottarGrafico(id) {

        new Chart(document.getElementById(id), {
            type: 'bar',
            data: {
                labels: ["1900", "1950", "1999", "2050"],
                datasets: [
                    {
                        label: "Africa",
                        backgroundColor: 'blue',
                        data: [133, 221, 783, 2478]
                    }, {
                        label: "Europe",
                        backgroundColor: "orange",
                        data: [408, 547, 675, 734]
                    }
                ]
            },
            options: {
                title: {
                    display: true,
                    text: 'Population growth (millions)',
                    fontColor: '#fff'

                },
                legend: {
                    labels: {
                        fontColor: '#fff'
                    },
                    fontColor: '#fff'
                }
            }
        });
    }

    // Variaveis Globais
    var pace = 0
    var Velocidade = 0
    var markers = [];
    // Cores
    var cores = ['#FFFFFF', '#FF0000', '#00FF00', '#0000FF', '#FF00FF', '#00FFFF', '#FF7F00', '#99CC32', '#D8D8BF', '#00009C', '#871F78', '#007FFF', '#FF1493', '#DC143C', '#2F4F4F', '#1E90FF', '#836FFF', '#BA55D3', '#FF7F50', '#B0E0E6', '#8B0000', '#50C878', '#831D1C', '#78866B', '#6B8E23', '#8FBC8F', '#FF00FF', '#FBEC5D', '#E9967A', '#008080']

    function iniciarMarcacao(infos) {
        var unique = infos.slice().reverse()

        var balao = {
            path: 'M10,1.375c-3.17,0-5.75,2.548-5.75,5.682c0,6.685,5.259,11.276,5.483,11.469c0.152,0.132,0.382,0.132,0.534,0c0.224-0.193,5.481-4.784,5.483-11.469C15.75,3.923,13.171,1.375,10,1.375 M10,17.653c-1.064-1.024-4.929-5.127-4.929-10.596c0-2.68,2.212-4.861,4.929-4.861s4.929,2.181,4.929,4.861C14.927,12.518,11.063,16.627,10,17.653 M10,3.839c-1.815,0-3.286,1.47-3.286,3.286s1.47,3.286,3.286,3.286s3.286-1.47,3.286-3.286S11.815,3.839,10,3.839 M10,9.589c-1.359,0-2.464-1.105-2.464-2.464S8.641,4.661,10,4.661s2.464,1.105,2.464,2.464S11.359,9.589,10,9.589',
            fillColor: 'yellow',
            fillOpacity: 0.8,
            scale: 1,
            strokeColor: 'gold',
            strokeWeight: 14
        }

        var ponto = new google.maps.LatLng(unique[0].gps.lat, unique[0].gps.lng)

        var marker = new google.maps.Marker({
            position: ponto,
            icon: balao,
            map: map
        })
    }
    function setMapOnAll(map) {
        console.log(markers)
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(map);
        }
    }
    function clearMarkers() {
        setMapOnAll(null);
    }
    function deleteMarkers() {
        clearMarkers();
        markers = [];
    }

    function carregar() {
        $.ajax({
            cache: false,
            url: '/dados/info',
            success: (dados) => {

                deleteMarkers()

                var todasInfosCompetidor = []

                let { participantes, infos, gps } = dados

                for (dado in participantes) {
                    for (info in infos) {
                        if (participantes[dado].devAdress == infos[info].devAdress) {
                            var gpsFiltered = gps.filter((value) => {
                                return value.devAdress === participantes[dado].devAdress
                            })
                            todasInfosCompetidor.push({ participante: participantes[dado], information: infos[info], gps: gpsFiltered })
                        }
                    }
                }

                definirColocacao(todasInfosCompetidor)
                plottarDados(todasInfosCompetidor)

            },
            error: (e) => {
                console.error('Error', e)
            }
        })
    }
    function calcularMomento(momento1, momento2) {
        return momento2 - momento1
    }
    function tranformarMomentoSegundos(momento) {
        var tempo = momento.split(':')
        var horas = tempo[0]
        var minutos = tempo[1]

        segundos = (Number(horas) * 3600) + (Number(minutos) * 60) + Number(tempo[2])
        return segundos
    }
    function filtrarHorario(momento) {
        var horas = momento.split('T')
        horas = horas[1].split('.')
        return horas[0]
    }
    function calcularVelocidade(distancia, tempo) {
        if (distancia <= 0 || tempo <= 0) {
            return (0).toFixed(2)
        } else {
            var velocidade = distancia / tempo
            return (velocidade * 3.6).toFixed(2)
        }
    }
    function calcularPace(distancia, tempo) {
        if (distancia <= 0 || tempo <= 0) {
            return `00:00`
        } else {
            var minutos = Number(tempo) / 60
            var quilometros = Number(distancia) / 1000
            var pace = minutos / quilometros
            if (pace < 10) {
                if (((pace * 60) % 60) < 10) {
                    return `0${parseInt(pace)}:0${parseInt(((pace * 60) % 60))}`
                } else {
                    return `0${parseInt(pace)}:${parseInt(((pace * 60) % 60))}`
                }
            } else {
                return `${parseInt(pace)}:${parseInt(((pace * 60) % 60))}`
            }
        }
    }
    function definirColocacao(info) {
        function comparer(a, b) {
            if (a.information.distanciaTotal < b.information.distanciaTotal)
                return 1;

            if (a.information.distanciaTotal > b.information.distanciaTotal)
                return -1;

            return 0;
        }

        info.sort(comparer);

    }
    function conectar(id, value, type = 'inner') {
        if (type == 'inner') document.getElementById(id).innerHTML = value
        if (type == 'src') document.getElementById(id).src = value
    }
    function plottarDadosTelona(infos) {
        if (info < 5) {
            if (infos[info].gps.length != 0) {
                iniciarMarcacao(infos[info].gps)
            }

            let distancia = infos[info].information.distanciaTotal
            var momentoInicialInicio = filtrarHorario(infos[info].information.momentoInicio),
                momentoAtualInicio = filtrarHorario(infos[info].information.momentoAtual),
                momentoDiferenca = calcularMomento(tranformarMomentoSegundos(momentoInicialInicio),
                    tranformarMomentoSegundos(momentoAtualInicio))

            conectar(`nome${Number(info) + 1}`, infos[info].participante.nome)
            conectar(`distancia${Number(info) + 1}`, distancia)
            conectar(`img${Number(info) + 1}`, `/img/competidores/${infos[info].participante.foto}`, 'src')
            conectar(`velocidade${Number(info) + 1}`, calcularVelocidade(Number(distancia), momentoDiferenca))
            conectar(`pace${Number(info) + 1}`, calcularPace(Number(distancia), momentoDiferenca))

            $(`#icone${Number(info) + 1}`)
                .css('color', `${cores[Number(infos[info].participante.corPin) - 1]}`)

        } else {
            console.log('Ultrapassada')
        }
    }
    function plottarDados(infos) {
        for (info in infos) {

            plottarDadosTelona(infos)

        }
    }

</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCER9PMT7J3e41ErfeOyB9MCBCZaELJEQU&callback=initMap" async
    defer></script>

</html>