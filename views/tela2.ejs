<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <!-- CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/materialize.min.css">
    <link href="css/index.css" rel="stylesheet" />

    <!-- Javascript  -->
    <script src="js/jquery.js" type="text/javascript"></script>
    <script src="js/bootstrap.bundle.min.js" type="text/javascript"></script>
    <script src="js/bootstrap-dash.js"></script>
    <script src="js/scrollbarEffect.js"></script>
    <script src="js/materialize.min.js"></script>

    <!-- Grafico -->
    <script src="js/Chart.bundle.min.js"></script>

    <!-- Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="shortcut icon" href="#">

</head>

<body id="home" onload="iniciar()">

    <div id="container" style="height: 100%; position: absolute;">

        <!-- Logo -->
        <div>
            <div id="logo">
                <img src="img/AmericanTowerLogo.png">
            </div>
        </div>

        <div id="content" class="col-md-12">
            <!-- Map -->
            <div id="estmapa" class="row">
                <div id="mapa" class="col-md-12">
                    <div id="map"></div>
                </div>
            </div>
        </div>


        <div id="conteudo">
            <div class="fileira">
                <div id="linha" class="row">
                    <div class="col-sm">
                        <div class="card border-dark bg-danger rounded-0 text-white">
                            <div id="head1" class="card-header">
                                <div class="media">
                                    <img id="img6" src="./img/competidores/generic.png"
                                        class="rounded-circle mx-auto d-block border border-dark">

                                    <div class="media-body" style="font-size: 15px;">
                                        <h5
                                            style="text-align: center; margin-top: 10px; margin-left: 65px; font-size: 20px; text-align: center">
                                            6<sup>th</sup> <span id="nome6"></span>
                                            <i class="align-self-center mr-2 small material-icons"
                                                style="position: absolute; top: -20px; right: 0; color: red">location_on</i>
                                        </h5>
                                    </div>
                                </div>
                            </div>
                            <div id="body1" class="card-body">

                                <ul class="list-unstyled" style="margin-bottom: 0%; margin-top: 2%; margin-left: 2%;">
                                    <li class="media">
                                        <i class="align-self-center mr-2 small material-icons">location_on</i>
                                        <div class="media-body" style="font-size: 15px;">
                                            <b class="mt-1 mb-1">Distancia Total (m)</b> <br>
                                            <span id="distancia6">0</span>
                                        </div>
                                    </li>
                                    <li class="media my-4">
                                        <i class="align-self-center mr-2 small material-icons">directions_run</i>
                                        <div class="media-body" style="font-size: 15px">
                                            <b class="mt-1 mb-1">Velocidade (Km/h)</b> <br>
                                            <span id="velocidade6">0.00</span>
                                        </div>
                                    </li>
                                    <li class="media">
                                        <i class="align-self-center mr-2 small material-icons">timer</i>
                                        <div class="media-body" style="font-size: 15px">
                                            <b class="mt-1 mb-1">Ritmo (Minutos/Km)</b> <br>
                                            <span id="pace6">0</span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm">
                        <div class="card bg-danger rounded-0 border-dark text-white">
                            <div id="head2" class="card-header">
                                <img id="img7" src="./img/competidores/generic.png"
                                    class="rounded-circle mx-auto d-block border border-dark">
                                <div class="media-body" style="font-size: 15px;">
                                    <h5
                                        style="text-align: center; margin-top: 10px; margin-left: 65px; font-size: 20px; text-align: center">
                                        7<sup>th</sup> <span id="nome7"></span>
                                        <i class="align-self-center mr-2 small material-icons"
                                            style="position: absolute; top: -20px;right: 0; color: blue">location_on</i>
                                    </h5>
                                </div>
                            </div>
                            <div id="body2" class="card-body ">
                                <ul class="list-unstyled" style="margin-bottom: 0%; margin-top: 2%; margin-left: 2%;">
                                    <li class="media">
                                        <i class="align-self-center mr-2 small material-icons">location_on</i>
                                        <div class="media-body" style="font-size: 15px;">
                                            <b class="mt-1 mb-1">Distancia Total (m)</b> <br>
                                            <span id="distancia7">0</span>
                                        </div>
                                    </li>
                                    <li class="media my-4">
                                        <i class="align-self-center mr-2 small material-icons">directions_run</i>
                                        <div class="media-body" style="font-size: 15px">
                                            <b class="mt-1 mb-1">Velocidade (Km/h)</b> <br>
                                            <span id="velocidade7">0.00</span>
                                        </div>
                                    </li>
                                    <li class="media">
                                        <i class="align-self-center mr-2 small material-icons">timer</i>
                                        <div class="media-body" style="font-size: 15px">
                                            <b class="mt-1 mb-1">Ritmo (Minutos/Km)</b> <br>
                                            <span id="pace7">0</span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm">
                        <div class="card bg-danger rounded-0 border-dark text-white">
                            <div id="head3" class="card-header">
                                <img id="img8" src="./img/competidores/generic.png"
                                    class="rounded-circle mx-auto d-block border border-dark">

                                <div class="media-body" style="font-size: 15px;">
                                    <h5
                                        style="text-align: center; margin-top: 10px; margin-left: 65px; font-size: 20px; text-align: center">
                                        8<sup>th</sup> <span id="nome8"></span>
                                        <i class="align-self-center mr-2 small material-icons"
                                            style="position: absolute; top: -20px;right: 0; color: yellow">location_on</i>
                                    </h5>
                                </div>
                            </div>
                            <div id="body3" class="card-body">
                                <ul class="list-unstyled" style="margin-bottom: 0%; margin-top: 2%; margin-left: 2%;">
                                    <li class="media">
                                        <i class="align-self-center mr-2 small material-icons">location_on</i>
                                        <div class="media-body" style="font-size: 15px;">
                                            <b class="mt-1 mb-1">Distancia Total (m)</b> <br>
                                            <span id="distancia8">0</span>
                                        </div>
                                    </li>
                                    <li class="media my-4">
                                        <i class="align-self-center mr-2 small material-icons">directions_run</i>
                                        <div class="media-body" style="font-size: 15px">
                                            <b class="mt-1 mb-1">Velocidade (Km/h)</b> <br>
                                            <span id="velocidade8">0.00</span>
                                        </div>
                                    </li>
                                    <li class="media">
                                        <i class="align-self-center mr-2 small material-icons">timer</i>
                                        <div class="media-body" style="font-size: 15px">
                                            <b class="mt-1 mb-1">Ritmo (Minutos/Km)</b> <br>
                                            <span id="pace8">0</span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm">
                        <div class="card bg-danger rounded-0 border-dark text-white">
                            <div id="head4" class="card-header">
                                <img id="img9" src="./img/competidores/generic.png"
                                    class="rounded-circle mx-auto d-block border border-dark">

                                <div class="media-body" style="font-size: 15px;">
                                    <h5
                                        style="text-align: center; margin-top: 10px; margin-left: 65px; font-size: 20px; text-align: center">
                                        9<sup>th</sup> <span id="nome9"></span>
                                        <i class="align-self-center mr-2 small material-icons"
                                            style="position: absolute; top: -20px;right: 0; color: green">location_on</i>
                                    </h5>
                                </div>
                            </div>
                            <div id="body4" class="card-body text-white" style="font-size: 15px">
                                <ul class="list-unstyled" style="margin-bottom: 0%; margin-top: 2%; margin-left: 2%;">
                                    <li class="media">
                                        <i class="align-self-center mr-2 small material-icons">location_on</i>
                                        <div class="media-body" style="font-size: 15px;">
                                            <b class="mt-1 mb-1">Distancia Total (m)</b> <br>
                                            <span id="distancia9">0</span>
                                        </div>
                                    </li>
                                    <li class="media my-4">
                                        <i class="align-self-center mr-2 small material-icons">directions_run</i>
                                        <div class="media-body" style="font-size: 15px">
                                            <b class="mt-1 mb-1">Velocidade (Km/h)</b> <br>
                                            <span id="velocidade9">0.00</span>
                                        </div>
                                    </li>
                                    <li class="media">
                                        <i class="align-self-center mr-2 small material-icons">timer</i>
                                        <div class="media-body" style="font-size: 15px">
                                            <b class="mt-1 mb-1">Ritmo (Minutos/Km)</b> <br>
                                            <span id="pace9">0</span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm">
                        <div class="card bg-danger rounded-0 border-dark text-white">
                            <div id="head5" class="card-header">
                                <img id="img10" src="./img/competidores/generic.png"
                                    class="rounded-circle mx-auto d-block border border-dark">

                                <div class="media-body" style="font-size: 15px;">
                                    <h5
                                        style="text-align: center; margin-top: 10px; margin-left: 65px; font-size: 20px; text-align: center">
                                        10<sup>th</sup> <span id="nome10"></span>
                                        <i class="align-self-center mr-2 small material-icons"
                                            style="position: absolute; top: -20px;right: 0; color: goldenrod">location_on</i>
                                    </h5>
                                </div>
                            </div>
                            <div id="body5" class="card-body  text-white">
                                <ul class="list-unstyled" style="margin-bottom: 0%; margin-top: 2%; margin-left: 2%;">
                                    <li class="media">
                                        <i class="align-self-center mr-2 small material-icons">location_on</i>
                                        <div class="media-body" style="font-size: 15px;">
                                            <b class="mt-1 mb-1">Distancia Total (m)</b> <br>
                                            <span id="distancia10">0</span>
                                        </div>
                                    </li>
                                    <li class="media my-4">
                                        <i class="align-self-center mr-2 small material-icons">directions_run</i>
                                        <div class="media-body" style="font-size: 15px">
                                            <b class="mt-1 mb-1">Velocidade (Km/h)</b> <br>
                                            <span id="velocidade10">0.00</span>
                                        </div>
                                    </li>
                                    <li class="media">
                                        <i class="align-self-center mr-2 small material-icons">timer</i>
                                        <div class="media-body" style="font-size: 15px">
                                            <b class="mt-1 mb-1">Ritmo (Minutos/Km)</b> <br>
                                            <span id="pace10">0</span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div id="conteudo-mobile">
            <div class="media mt-0">
                <img class="mr-3 " src="img/competidores/generic.png" alt="Generic placeholder image">
                <div class="media-body">
                    <h5 class="mt-0">Media heading</h5>
                    Cras sit amet nibh libero, in gravida nulla. Nulla vel metus scelerisque ante sollicitudin. Cras
                    purus odio, vestibulum in vulputate at, tempus viverra turpis. Fusce condimentum nunc ac nisi
                    vulputate fringilla. Donec lacinia congue felis in faucibus.
                </div>
            </div>
            <hr>
        </div>

    </div>

</body>

<script>

    $(document).ready(() => {
        carregar()
    })

    function iniciar() {
        setInterval(carregar, 10000)
    }

    var map

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: -23.5911131, lng: -46.6475914 },
            zoom: 12,
            styles: [{
                "featureType": "poi",
                "stylers": [{
                    "visibility": "off"
                }]
            }],
            scrollwheel: false,
            disableDefaultUI: true
        });
    }

    function plottarGrafico(id) {

        new Chart(document.getElementById(id), {
            type: 'bar',
            data: {
                labels: ["1900", "1950", "1999", "2050"],
                datasets: [
                    {
                        label: "Africa",
                        backgroundColor: 'blue',
                        data: [133, 221, 783, 2478]
                    }, {
                        label: "Europe",
                        backgroundColor: "orange",
                        data: [408, 547, 675, 734]
                    }
                ]
            },
            options: {
                title: {
                    display: true,
                    text: 'Population growth (millions)',
                    fontColor: '#fff'

                },
                legend: {
                    labels: {
                        fontColor: '#fff'
                    },
                    fontColor: '#fff'
                }
            }
        });
    }

    // Variaveis Globais
    var pace = 0
    var Velocidade = 0

    function iniciarMarcacao(infos) {

        var unique = infos.slice().reverse()

        var ponto = new google.maps.LatLng(unique[0].gps.lat, unique[0].gps.lng)
        var marker = new google.maps.Marker({
            position: ponto,
            map: map,
            title: 'oioio'
        })

    }

    function carregar() {
        $.ajax({
            cache: false,
            url: '/dados/info',
            success: (dados) => {

                var todasInfosCompetidor = []

                let { participantes, infos, gps } = dados

                for (dado in participantes) {
                    for (info in infos) {
                        if (participantes[dado].nome == infos[info].nomeCompetidor) {
                            var gpsFiltered = gps.filter((value) => {
                                return value.devAdress === participantes[dado].devAdress
                            })

                            todasInfosCompetidor.push({ participante: participantes[dado], information: infos[info], gps: gpsFiltered })
                        }
                    }
                }

                definirColocacao(todasInfosCompetidor)
                plottarDados(todasInfosCompetidor)

                // Marcador no mapa
                // console.log(todasInfosCompetidor)

            },
            error: (e) => {
                console.error('Error', e)
            }
        })
    }

    function calcularMomento(momento1, momento2) {
        return momento2 - momento1
    }

    function tranformarMomentoSegundos(momento) {
        var tempo = momento.split(':')
        var horas = tempo[0]
        var minutos = tempo[1]

        segundos = (Number(horas) * 3600) + (Number(minutos) * 60) + Number(tempo[2])
        return segundos
    }

    function filtrarHorario(momento) {
        var horas = momento.split('T')
        horas = horas[1].split('.')
        return horas[0]
    }

    function calcularVelocidade(distancia, tempo) {
        if (distancia <= 0 || tempo <= 0) {
            return (0).toFixed(2)
        } else {
            var velocidade = distancia / tempo
            return (velocidade * 3.6).toFixed(2)
        }
    }

    function calcularPace(distancia, tempo) {
        if (distancia <= 0 || tempo <= 0) {
            return `00:00`
        } else {
            var minutos = Number(tempo) / 60
            var quilometros = Number(distancia) / 1000
            var pace = minutos / quilometros
            if (pace < 10) {
                if (((pace * 60) % 60) < 10) {
                    return `0${parseInt(pace)}:0${parseInt(((pace * 60) % 60))}`
                } else {
                    return `0${parseInt(pace)}:${parseInt(((pace * 60) % 60))}`
                }
            } else {
                return `${parseInt(pace)}:${parseInt(((pace * 60) % 60))}`
            }
        }
    }

    function definirColocacao(info) {

        function comparer(a, b) {
            if (a.information.distanciaTotal < b.information.distanciaTotal)
                return 1;

            if (a.information.distanciaTotal > b.information.distanciaTotal)
                return -1;

            return 0;
        }

        info.sort(comparer);

    }

    function plottarDados(infos) {
        for (info in infos) {
            if (info >= 5 && info < 10) {
                if (infos[info].gps.length != 0) {
                    iniciarMarcacao(infos[info].gps)
                }

                document.getElementById(`nome${Number(info) + 1}`).innerHTML = infos[info].participante.nome
                document.getElementById(`distancia${Number(info) + 1}`).innerHTML = infos[info].information.distanciaTotal

                var dnow = new Date()
                var momentoInicialInicio = filtrarHorario(infos[info].information.momentoInicio)
                var momentoAtualInicio = filtrarHorario(infos[info].information.momentoAtual)

                var momentoDiferenca = calcularMomento(tranformarMomentoSegundos(momentoInicialInicio),
                    tranformarMomentoSegundos(momentoAtualInicio))


                document.getElementById(`velocidade${Number(info) + 1}`).innerHTML = calcularVelocidade(
                    Number(infos[info].information.distanciaTotal),
                    momentoDiferenca
                )

                document.getElementById(`img${Number(info) + 1}`).src = `/img/competidores/${infos[info].participante.foto}`

                document.getElementById(`pace${Number(info) + 1}`).innerHTML = calcularPace(
                    Number(infos[info].information.distanciaTotal),
                    momentoDiferenca
                )

            } else {
                console.log('Ultrapassada')
            }
        }
    }
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCER9PMT7J3e41ErfeOyB9MCBCZaELJEQU&callback=initMap" async
    defer></script>

</html>